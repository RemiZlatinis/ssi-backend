<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Agent Status</title>
    <style>
      body {
        font-family: sans-serif;
      }
      #agents {
        list-style: none;
        padding: 0;
      }
      .agent {
        padding: 8px;
        border: 1px solid #ccc;
        margin-bottom: 5px;
        border-radius: 4px;
      }
      .connected {
        background-color: #d4edda;
        color: #155724;
      }
      .disconnected {
        background-color: #f8d7da;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <h1>Live Agent Status</h1>
    <ul id="agents"></ul>

    <script>
      const agentList = document.getElementById("agents");
      const agentStatus = new Map();

      function render() {
        agentList.innerHTML = "";
        for (const [id, agent] of agentStatus.entries()) {
          const li = document.createElement("li");
          li.id = `agent-${id}`;
          li.className = `agent ${agent.status}`;
          li.textContent = `${agent.agent_name} (${agent.status})`;
          agentList.appendChild(li);
        }
      }

      const evtSource = new EventSource(
        "http://127.0.0.1:8000/sse/agent-status/"
      );

      evtSource.onmessage = function (event) {
        const data = JSON.parse(event.data);
        console.log("Received data:", data);

        if (Array.isArray(data)) {
          // Initial full list
          data.forEach((agent) => agentStatus.set(agent.agent_id, agent));
        } else {
          // Single update
          agentStatus.set(data.agent_id, data);
        }
        render();
      };

      evtSource.onerror = function (err) {
        console.error("EventSource failed:", err);
        const li = document.createElement("li");
        li.textContent = "Connection to server lost. Retrying...";
        li.style.color = "red";
        agentList.prepend(li);
      };
    </script>
  </body>
</html>
